<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/livecanvas-team/ninjabootstrap/dist/css/bootstrap.min.css">
  <script defer src="https://unpkg.com/vanilla-counter"></script>
  <title>Statistik</title>
  <style>
    @import url('https://v1.fontapi.ir/css/SFProDisplay');
  </style>

  <style>
    body {
      margin: 0;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #F7F7F7;
      color: #333333;
      padding: 16px;
    }

    .card {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }

    .title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 14px;
      color: #555;
      margin-bottom: 16px;
    }

    .statistic-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .statistic-label {
      font-size: 16px;
      color: #777;
    }

    .statistic-value {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }

    .avatar-list {
      display: flex;
      gap: 16px;
      overflow-x: auto;
    }

    .avatar-item {
      text-align: center;
    }

    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .name {
      font-size: 14px;
      font-weight: bold;
      color: #333;
      margin-top: 8px;
    }

    .timja {
      font-size: 12px;
      color: #777;
    }
  </style>
</head>

<div>

  <div class="card"
    style="padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);margin: 16px; margin-bottom: 20px;">
    <div class="card-header judul" style="font-size: 43px; font-weight: bold; color: #333; margin-bottom: 10px;">
      Statistik Kehadiran
    </div>
    <div class="card-body deskripsi" style="font-size: 14px; color: #666;">
      <p></p>
    </div>
  </div>

  <div class="card"
    style="padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);margin: 16px; margin-bottom: 20px;">
    <div class="card-header" style="font-size: 23px; font-weight: bold; color: #333; margin-bottom: 10px;">
      Kehadiran Per Timja
    </div>
    <div class="card-body" style="font-size: 14px; color: #666;">
      <p>Statistik Kehadiran Per Tim Kerja</p>
    </div>

    <div class="container">
      <div class="row rounded bg-light text-center py-4 counter-timja">
        <!-- Data akan dimuat melalui AJAX -->
      </div>
      <div class="text-center mt-4">
        <p class="lead"><b><span id="total-hadir">0</span></b> pegawai yang hadir pada pertemuan ini</p>
      </div>
    </div>
  </div>

  <!-- Card Top Kehadiran -->
  <div class="card"
    style="padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);margin: 16px; margin-bottom: 20px;">
    <div class="title">Pertama Hadir</div>
    <div style="font-size: 14px; color: gray; margin-bottom: 16px">Pegawai yang hadir tepat waktu dalam pertemuan</div>
    <div class="avatar-list"></div>
    <div style="font-size: 12px; color: gray; text-align: center; margin-top: 16px;">
      <span class="statistik-hadir">0</span> pegawai yang hadir pada pertemuan ini
    </div>
  </div>

  <!-- Card Product Stats -->
  <div class="card"
    style="padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);margin: 16px; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-around; align-items: center;">
      <div style="text-align: center;">
        <div style="font-size: 14px; color: gray;">Hadir</div>
        <div class="statistik-total-hadir" style="font-size: 32px; font-weight: bold; color: black;">0</div>
      </div>
      <div style="height: 40px; width: 1px; background: rgba(128, 128, 128, 0.5);"></div>

      <div style="text-align: center;">
        <div style="font-size: 14px; color: gray;">Tepat Waktu</div>
        <div class="statistik-tepat-total" style="font-size: 32px; font-weight: bold; color: black;">0</div>
      </div>
      <div style="height: 40px; width: 1px; background: rgba(128, 128, 128, 0.5);"></div>

      <div style="text-align: center;">
        <div style="font-size: 14px; color: gray;">Terlambat</div>
        <div class="statistik-terlambat-total" style="font-size: 32px; font-weight: bold; color: black;">0</div>
      </div>
      <div style="height: 40px; width: 1px; background: rgba(128, 128, 128, 0.5);"></div>

      <div style="text-align: center;">
        <div style="font-size: 14px; color: gray;">Tidak Hadir</div>
        <div class="statistik-tidak-hadir-total" style="font-size: 32px; font-weight: bold; color: black;">0</div>
      </div>
    </div>
  </div>

  <!-- Card Online Sales -->
  <div class="card"
    style="padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);margin: 16px; margin-bottom: 20px;">
    <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
      <div>
        <div style="font-size: 14px; color: gray;">Total Pegawai</div>
        <div class="total-pegawai" style="font-size: 32px; font-weight: bold; color: black;">0</div>
      </div>
      <div class="rata-rata-kehadiran" style="font-size: 14px; color: green; margin-left: auto;">0%</div>
    </div>
    <div style="display: flex; justify-content: space-around; align-items: center;">
      <canvas id="attendanceChart" width="400" height="200"></canvas>
    </div>
  </div>

  <!-- Card Presensi -->
  <div class="card hstack"
    style="padding: 20px; border-radius: 15px; background: #fff; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); margin: 16px; display: flex; justify-content: space-around; align-items: center;">

    <!-- Tidak Hadir Section -->
    <div style="text-align: center; margin: 0 16px;">
      <div style="font-size: 14px; color: gray;">Hadir</div>
      <div class="statistik-hadir" style="font-size: 32px; font-weight: bold;">0%</div>
    </div>

    <!-- Tepat Waktu Section -->
    <div style="text-align: center; margin: 0 16px;">
      <div style="font-size: 14px; color: gray;">Tepat Waktu</div>
      <div class="statistik-tepat-waktu" style="font-size: 32px; font-weight: bold;">0%</div>
    </div>

    <!-- Divider -->
    <div style="width: 1px; height: 60px; background-color: #f0f0f0;"></div>

    <!-- Terlambat Section -->
    <div style="text-align: center; margin: 0 16px;">
      <div style="font-size: 14px; color: gray;">Terlambat</div>
      <div class="statistik-terlambat" style="font-size: 32px; font-weight: bold;">0%</div>
    </div>

    <!-- Divider -->
    <div style="width: 1px; height: 60px; background-color: #f0f0f0;"></div>

    <!-- Tidak Hadir Section -->
    <div style="text-align: center; margin: 0 16px;">
      <div style="font-size: 14px; color: gray;">Tidak Hadir</div>
      <div class="statistik-tidak-hadir" style="font-size: 32px; font-weight: bold;">0%</div>
    </div>

  </div>

  <div class="card"
    style="padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin: 16px; margin-bottom: 20px;">
    <div class="title">Pegawai Tidak Hadir / Belum Presensi</div>
    <div style="font-size: 14px; color: gray; margin-bottom: 16px">Pegawai yang tidak hadir atau belum melakukan
      presensi</div>
    <div id="pegawai-tidak-hadir">
      <!-- Daftar pegawai yang tidak hadir akan dimasukkan di sini oleh jQuery -->
    </div>
  </div>

  <!-- Script -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    $(document).ready(function () {
      const apiUrl = "<?php echo base_url('api/show-statistik'); ?>";
      const requestData = { id_pertemuan: "4" };

      $.ajax({
        url: apiUrl,
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(requestData),
        success: function (response) {
          if (response.status) {
            const { statistik, top_kehadiran, pegawai_tidak_hadir } = response;

            // Update judul dan deskripsi
            $(".judul").text(response.nama_pertemuan);
            $(".deskripsi").text(response.deskripsi);

            // Update statistik
            $(".statistik-total-hadir").text(statistik.hadir);
            $(".statistik-tepat-total").text(statistik.tepat_waktu);
            $(".statistik-terlambat-total").text(statistik.terlambat);
            $(".statistik-tidak-hadir-total").text(statistik.tidak_hadir);

            // Total Pegawai
            const totalPegawai = statistik.hadir + statistik.tidak_hadir;
            $(".total-pegawai").text(totalPegawai);

            // Update persentase statistik
            $(".statistik-hadir").text(statistik.persen_hadir.toFixed(2) + "%");
            $(".statistik-tepat-waktu").text(statistik.persen_tepat_waktu.toFixed(2) + "%");
            $(".statistik-terlambat").text(statistik.persen_terlambat.toFixed(2) + "%");
            $(".statistik-tidak-hadir").text(statistik.persen_tidak_hadir.toFixed(2) + "%");

            // Rata-rata kehadiran
            const rataRataKehadiran = (parseFloat(statistik.persen_hadir) + parseFloat(statistik.persen_tidak_hadir) + parseFloat(statistik.persen_tepat_waktu) + parseFloat(statistik.persen_terlambat)) / 4;
            $(".rata-rata-kehadiran").text(rataRataKehadiran.toFixed(2) + "%");

            // Inisialisasi grafik menggunakan Chart.js
            var ctx = document.getElementById('attendanceChart').getContext('2d');
            var attendanceChart = new Chart(ctx, {
              type: 'bar', // Jenis grafik: batang (bar)
              data: {
                labels: ['Tepat Waktu', 'Terlambat', 'Tidak Hadir'], // Label sumbu X
                datasets: [{
                  label: 'Persentase Kehadiran',
                  data: [statistik.persen_tepat_waktu.toFixed(2), statistik.persen_terlambat.toFixed(2), statistik.persen_tidak_hadir.toFixed(2)], // Data untuk batang
                  backgroundColor: ['#36A2EB', '#FF9F40', '#FF6384'], // Warna batang
                  borderColor: ['#36A2EB', '#FF9F40', '#FF6384'],
                  borderWidth: 1
                }]
              },
              options: {
                scales: {
                  y: {
                    beginAtZero: true, // Memulai sumbu Y dari nol
                    max: 100 // Nilai maksimum adalah 100%
                  }
                }
              }
            });

            // Update top kehadiran
            const avatarList = $(".avatar-list");
            avatarList.empty();
            top_kehadiran.forEach((item) => {
              const fotoUrl = item.foto
                ? `https://docs.google.com/thumbnail?id=${item.foto}`
                : `https://www.tapback.co/api/avatar/${item.nama}`;
              const avatarItem = `
              <div class="avatar-item" style="margin-bottom: 10px;">
                <img class="avatar" src="${fotoUrl}" alt="${item.nama}" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 3px solid #A0A0A0; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
                <div class="name">${item.nama}</div>
                <div class="timja">${item.timja}</div>
              </div>`;
              avatarList.append(avatarItem);
            });

            // Update Rekap Timja
            const timjaContainer = $(".counter-timja");
            timjaContainer.empty();

            let totalHadirTimja = 0;
            const rekapPerTimja = response.rekap_per_timja;

            if (rekapPerTimja) {
              Object.entries(rekapPerTimja).forEach(([timja, jumlah]) => {
                totalHadirTimja += jumlah;

                const col = `
                <div class="col-6 col-lg-3">
                <span class="fw-bold display-6 mb-5" data-vanilla-counter data-start-at="0" data-end-at="${jumlah}" data-time="1000" data-delay="60"></span>
                <p class="lead text-uppercase"><b>${timja}</b></p></div>`;
                timjaContainer.append(col);
              });

              // Update total pegawai hadir per timja
              $("#total-hadir").text(totalHadirTimja);

              // Jalankan animasi angka setelah elemen dimuat
              VanillaCounter();
            }

            // Looping untuk membuat card dari data pegawai tidak hadir
            const pegawaiTidakHadirContainer = $('#pegawai-tidak-hadir');
            pegawai_tidak_hadir.forEach(function (pegawai) {
              const fotoUrl = pegawai.foto
                ? `https://docs.google.com/thumbnail?id=${pegawai.foto}`
                : `https://www.tapback.co/api/avatar/${pegawai.nama}`;
              const cardHtml = `
              <div class="pegawai-card" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px; border-radius: 8px; background-color: #f9f9f9;">
                <!-- Foto dengan border gray -->
                <div style="width: 70px; height: 70px; border-radius: 50%; overflow: hidden; border: 2px solid gray; display: flex; justify-content: center; align-items: center;">
                  <img src="${fotoUrl}" alt="${pegawai.nama}" style="width: 100%; height: 100%; object-fit: cover;">
                </div>

                <!-- Nama, Timja, dan Alasan Tidak Hadir -->
                <div style="flex: 1; margin-left: 12px; display: flex; flex-direction: column; justify-content: space-between;">
                  <div style="font-size: 16px; font-weight: bold; color: #333;">
                    ${pegawai.nama}
                  </div>
                  <div style="font-size: 14px; color: gray;">
                    Timja: ${pegawai.timja}
                  </div>
                </div>

                <!-- Alasan Tidak Hadir di sisi kanan pojok -->
                <div style="font-size: 16px; font-weight: bold; color: #ff6b6b; text-align: right;">
                  Alasan: Tidak Presensi / Tidak Hadir
                </div>
              </div>
            `;

              // Menambahkan card ke dalam div #pegawai-tidak-hadir
              pegawaiTidakHadirContainer.append(cardHtml);
            });
          } else {
            alert(`Gagal memuat data: ${response.message}`);
          }
        },
        error: function (xhr, status, error) {
          console.error("Error saat memuat data:", error);
        }
      });
    });
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

  </body>

</html>
